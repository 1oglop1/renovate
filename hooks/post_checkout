#!/bin/bash

set -e

# We need to parse $IMAGE_NAME because $CACHE_TAG is broken on Docker Hub post_push

IFS=: read DOCKER_REPO CACHE_TAG <<< $IMAGE_NAME

echo "repo=${DOCKER_REPO}"
echo "tag=${CACHE_TAG}"
echo "tag=${DOCKER_TAG}"

SEMVER_REGEX="^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-slim)?$"

if ! [[ "$CACHE_TAG" =~ $SEMVER_REGEX ]]; then
  echo Not a semver tag - skipping
  exit
fi

major=${BASH_REMATCH[1]}
minor=${BASH_REMATCH[2]}
patch=${BASH_REMATCH[3]}

# Write the tag to package.json>version so that "renovate --version" is correct

sed -i "s/0.0.0-semantic-release/${major}.${minor}.${patch}/" package.json
